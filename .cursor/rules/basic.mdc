---
alwaysApply: true
---
# Правила для Cursor AI

## Общие правила
- Обращать внимание на правила проекта
- Перед созданием нового файла проверять, существует ли он в проекте
- Никогда не удалять PersistentVolumes

## Правила работы с сервером
- НИКОГДА не перезапускать сервер автоматически
- Всегда предупреждать пользователя перед любыми действиями с сервером
- При необходимости изменений в конфигурации сервера - только предлагать команды, не выполнять их
- Если нужно перезапустить сервер - только показать команду, но не выполнять её

## Правила тестирования
- Тестировать ВСЕ только через curl запросы к API
- Использовать только реальные HTTP запросы для проверки функциональности
- Если нужно протестировать что-то - использовать curl команды, а не создавать тесты
- Создавать тесты ТОЛЬКО если пользователь явно попросит "создай тест" или "напиши тест"
- Пиши docs strings всегда на английском
- Не пиши много комментариев, только самые необходимые
- Если ты пишешь тесты, то ты стараешься всегда искать проблему в тестах, а не в исходном коде
- Запускай тесты только командой "just test" или через poetry
- Обрабатывай как можно больше edge-кейсов
- Не забывай обновлять pytest.ini если нужно
- После того, как написал группу тестов запусти их через poetry и проверь на наличие ошибок
- Всегда используй существующую инфраструктуру - фабрики тестов, существующие фикстуры
- Старайся избегать дублирования кода
- КОГДА ЗАПУСКАЕШЬ ТЕСТЫ ЧЕРЕЗ poetry ВСЕГДА ЗАПУСКАЙ ИХ ТАК: ENV_FILE=.env.dev ENVIRONMENT=TESTING poetry run pytest -v
- Всегда после того, как написал тесты проверях их работоспособность и исправляй ошибки

### Правила использования фабрик тестов
- Для стандартных CRUD операций ВСЕГДА используй модульную структуру `test_factory` из `tests/utils/test_factory/`
- Всегда используй `BaseEndpointTestFactory` для стандартных CRUD тестов вместо написания тестов вручную
- Переиспользуй хуки из `TestHooksMixin` вместо дублирования логики
- Используй генераторы из `TestGeneratorsMixin` для стандартных тестов
- Используй валидаторы из `ResponseValidatorsMixin` для проверки ответов
- Выноси кастомные тесты (фильтры, права доступа и т.д.) в отдельные файлы (например, `test_equipment_filters.py`)
- Добавляй подробные docstrings для всех тестовых функций с описанием ожидаемого поведения
- Размер файла тестов не должен превышать 500 строк - разбивай на модули при необходимости
- При создании фабрики тестов для нового эндпоинта:
  1. Создай класс, наследующийся от `BaseEndpointTestFactory`
  2. Переопредели необходимые хуки (`_prepare_test_entities`, `_get_entity_creation_kwargs`, `_custom_*_assertions` и т.д.)
  3. Используй `generate_all_tests()` для генерации стандартных тестов
  4. Для кастомных тестов создай метод `generate_custom_tests()` и переопредели `generate_all_tests()`
- Используй хуки для кастомизации:
  - `_prepare_test_entities()` - для создания зависимых сущностей
  - `_get_entity_creation_kwargs()` - для настройки данных создания
  - `_get_entity_update_kwargs()` - для настройки данных обновления
  - `_customize_test_entity_data()` - для кастомизации данных перед отправкой в API
  - `_custom_*_assertions()` - для дополнительных проверок в тестах
- Разделяй `conftest` на модули: `conftest_db.py`, `conftest_auth.py`, `conftest_mocks.py`, `conftest_dependencies.py`
- Используй `test_db_session` и `test_db_client` для работы с БД
- Правильно очищай `dependency_overrides` после тестов
- Всегда используй маркеры pytest: `@pytest.mark.unit`, `@pytest.mark.integration`, `@pytest.mark.e2e`, `@pytest.mark.asyncio`

## Правила разработки
- Сначала анализировать проблему, потом предлагать решение
- Использовать базовые уровни для исправлений, а не локальные затычки
- Проверять существование файлов перед их изменением
- Для отладки использовать логи и curl запросы, а не создавать тестовые файлы

## Правила отладки ошибок
- При обнаружении ошибки ВСЕГДА выяснять полную структуру работы endpoint
- Анализировать весь путь выполнения от Router → Service → Repository → Database
- Изучать все слои архитектуры: Router, Service, Repository, Model, Database
- Проверять зависимости между компонентами
- Выяснять, как данные передаются между слоями
- Находить корневую причину ошибки, а не исправлять симптомы

### Правила работы с InfluxDB в тестах
- ВСЕГДА используй реальный InfluxDB через testcontainers, НИКОГДА не используй моки
- Все тесты, работающие с InfluxDB, должны использовать фикстуры из `conftest_influx.py`
- Обязательные фикстуры в параметрах теста: `influxdb_container` и `influx_client_dependency_override`
- Для фабрик тестов, работающих с InfluxDB, наследуйся от `InfluxDBMixin` из `tests/utils/test_factory/influx_mixin.py`
- ВСЕГДА настраивай InfluxDB для организации перед записью данных через `_setup_influxdb_for_organization()`
- ВСЕГДА создавай необходимые buckets перед записью данных через `_ensure_bucket_exists()`
- Используй методы миксина для записи данных:
  - `_write_statistic_data_to_influx()` - для статистических данных (AnalyticsV3_1h, AnalyticsV3_1d)
  - `_write_daily_analytics_data_to_influx()` - для ежедневных аналитических данных
  - `_write_timeseries_data_to_influx()` - для временных рядов (Metrics bucket)
- ВСЕГДА вызывай `write_api.flush()` и `write_api.close()` после записи данных
- Добавляй небольшую задержку (`await asyncio.sleep(1)`) после записи данных для обеспечения доступности
- ВСЕГДА закрывай InfluxDBClient после использования в блоке `finally`
- Для timeseries данных ВСЕГДА используй UTC с timezone (pytz.UTC), не используй naive datetime
- Учитывай часовой пояс пользователя при работе с временными метками - API принимает локальное время и конвертирует в UTC
- Типичные buckets: `Metrics` (timeseries), `AnalyticsV3_1h` (почасовая статистика), `AnalyticsV3_1d` (дневная статистика)
- Measurement name для статистических данных ДОЛЖЕН заканчиваться на UUID оборудования: `analytics-{equipment_uuid}`
- Tag `equipment` должен содержать UUID оборудования во всех типах данных
- НЕ создавай клиент напрямую без настройки организации
- НЕ забывай закрывать клиент и write_api
- НЕ используй naive datetime для timeseries данных - всегда UTC с timezone
- НЕ используй bucket без предварительного создания через `_ensure_bucket_exists`